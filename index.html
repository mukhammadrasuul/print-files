
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt</title>
    <style>
        body {
            font-family: monospace;
            font-size: 16px;
            margin: 0;
            padding: 0;
            background: #fff;
        }

        .receipt {
            width: 80mm; /* Standard receipt printer width */
            padding: 10px;
            box-sizing: border-box; /* Ensures padding doesn't add to width */
        }

        .center {
            text-align: center; /* Changed to center for logo as per typical receipts */
            margin-bottom: 5px;
        }

        .line {
            border-bottom: 1px dashed #000;
            margin: 6px 0;
        }

        .info {
            margin-bottom: 5px;
        }

        .info div { /* Ensure each info line is block to take full width */
            margin-bottom: 2px;
        }

        .info span:first-child { /* Label part of the info line */
            display: inline-block;
            min-width: 70px; /* Adjusted min-width for labels */
            font-weight: bold;
        }
        .info span.value { /* Value part of the info line */
            display: inline;
        }


        .items {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        .item-row span:first-child { /* Item name */
            flex-grow: 1;
            padding-right: 5px; /* Space between item name and count */
            word-break: break-word; /* Allow long item names to wrap */
        }
        .item-row span:last-child { /* Item count/price */
            text-align: right;
            min-width: 30px; /* Ensure some space for count/price */
        }


        .footer {
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
        }

        .bold {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="receipt">
        <div class="center">
            <img src="logo.jpg" alt="Logo" style="max-width: 60mm; max-height: 25mm; border-radius: 8px;">
        </div>
        <div class="info">
            <div><span>Бемор:</span> <span class="value" id="bemor-info"></span></div>
            <div><span>Тел №:</span> <span class="value" id="telefon-info"></span></div>
            <div><span>Шифокор:</span> <span class="value" id="doktor-info"></span></div>
            <div><span>Сана:</span> <span class="value" id="sana-info"></span></div>
        </div>
        <div class="line"></div>
        <div class="bold">Хизматлар</div>
        <div class="items" id="items-container"></div> <div class="line"></div>
        <div class="item-row bold" id="jami-summa-row"><span>Жами:</span><span id="jami-summa"></span></div>
        <div id="payment-details-container"></div> <div class="line" id="final-line-before-footer"></div>
        <div class="footer">
            Бизни танлаганингиз учун раҳмат!<br>
            Телефон: 90 275 03 23
        </div>
    </div>

    <script>
        // --- Configuration for Special Services ---
        // Add names of services that should get their own receipt. Case-insensitive.
        const SPECIAL_SERVICE_NAMES = ['фиброточ', 'УЗИ обший', 'УЗИ шитовидка', 'УЗИ ўт қопи', 'УЗИ мошонки', 'УЗИ сийдик системаси', 'ЕКГ'];

        // --- Global Print Job Management ---
        let printJobs = [];
        let currentPrintJobIndex = 0;
        let urlParams; // Will be initialized in DOMContentLoaded

        // --- Helper Functions (should be defined before use or within DOMContentLoaded) ---
        function safeGetValue(key, isNumber = false) {
            if (!urlParams) return isNumber ? 0 : ''; // Should not happen if called correctly
            const value = urlParams.get(key);
            if (value === null || value === "") {
                return isNumber ? 0 : '';
            }
            return isNumber ? parseFloat(value) : value;
        }

        function safeExplode(key) {
            if (!urlParams) return ['']; // Should not happen
            const value = urlParams.get(key);
            return (value && value !== "") ? value.split(",") : [''];
        }

        function numberFormat(number, decimals = 0, decPoint = '.', thousandsSep = ',') {
            number = (number + '').replace(/[^0-9+\-Ee.]/g, '');
            const n = !isFinite(+number) ? 0 : +number;
            const prec = !isFinite(+decimals) ? 0 : Math.abs(decimals);
            const sep = (typeof thousandsSep === 'undefined') ? ',' : thousandsSep;
            const dec = (typeof decPoint === 'undefined') ? '.' : decPoint;
            let s = '';
            const toFixedFix = function (num, pr) {
                const k = Math.pow(10, pr);
                return '' + (Math.round(num * k) / k).toFixed(pr);
            };
            s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.');
            if (s[0].length > 3) {
                s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
            }
            if ((s[1] || '').length < prec) {
                s[1] = s[1] || '';
                s[1] += new Array(prec - s[1].length + 1).join('0');
            }
            return s.join(dec);
        }

        // --- Function to populate receipt content for a given print job ---
        function populateReceiptContent(job) {
            // Patient info is static and set once initially.

            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = ''; // Clear previous items
            let counter = 1;

            if (job.items && job.items.length > 0) {
                job.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    const itemName = item.name || '';
                    const itemCount = item.count || '';
                    itemRow.innerHTML = `<span>${counter}) ${itemName}</span><span>${itemCount}</span>`;
                    itemsContainer.appendChild(itemRow);
                    counter++;
                });
            } else if (job.type === 'empty_shell_financials') {
                // No items to list, but financials will be shown.
                // itemsContainer remains empty.
            }


            // Financials visibility and content
            const jamiSummaRowEl = document.getElementById('jami-summa-row');
            const jamiSummaEl = document.getElementById('jami-summa');
            const paymentDetailsContainer = document.getElementById('payment-details-container');
            const finalLineEl = document.getElementById('final-line-before-footer');


            if (job.showFinancials) {
                const jamisummaVal = safeGetValue("jamisumma");
                const paidVal = safeGetValue("paid", true);
                const qarzdorlikVal = safeGetValue("qarzdorlik", true);

                jamiSummaEl.textContent = numberFormat(parseFloat(jamisummaVal) || 0, 0, '', ',');
                
                let paymentHtml = '';
                // Show payment details if paid or qarzdorlik is positive, or if they are explicitly zero but jamisumma is present
                if (urlParams.has('jamisumma')) { // Check if financial section is relevant at all
                    if (paidVal > 0 || qarzdorlikVal > 0 || (paidVal === 0 && qarzdorlikVal === 0) ) {
                        paymentHtml += `<div class="item-row"><span>Тўланди:</span><span>${numberFormat(paidVal, 0, '', ',')}</span></div>`;
                        paymentHtml += `<div class="item-row"><span>Қарздорлик:</span><span>${numberFormat(qarzdorlikVal, 0, '', ',')}</span></div>`;
                    }
                }
                paymentDetailsContainer.innerHTML = paymentHtml;

                // Ensure financial sections are visible
                jamiSummaRowEl.style.display = '';
                paymentDetailsContainer.style.display = '';
                finalLineEl.style.display = '';

            } else {
                jamiSummaEl.textContent = '';
                paymentDetailsContainer.innerHTML = '';
                // Hide financial sections
                jamiSummaRowEl.style.display = 'none';
                paymentDetailsContainer.style.display = 'none';
                finalLineEl.style.display = 'none'; // Hide the line above footer too if no financials
            }
        }

        // --- Function to execute the next print job ---
        function executeNextPrintJob() {
            if (currentPrintJobIndex < printJobs.length) {
                populateReceiptContent(printJobs[currentPrintJobIndex]);
                window.print(); // This will trigger onafterprint (if supported) or block
            }
            // Note: currentPrintJobIndex is incremented in the onafterprint handler
            // or after the blocking window.print() if onafterprint is not supported.
        }

        // --- Main script execution on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function () {
            urlParams = new URLSearchParams(window.location.search);

            // Populate static patient information once
            document.getElementById('bemor-info').textContent = `${safeGetValue("bemorismi")} (ID: ${safeGetValue("kirimid")})`;
            document.getElementById('telefon-info').textContent = `${safeGetValue("bemortelefon")} (${safeGetValue("bemoryili")})`;
            document.getElementById('doktor-info').textContent = safeGetValue("doktor");
            document.getElementById('sana-info').textContent = safeGetValue("sana");

            // Prepare service items
            const xizmatlarRaw = safeExplode("xizmatlar");
            const soniRaw = safeExplode("soni");
            const allServiceObjects = [];

            // Only create service objects if xizmatlar is not just a single empty string (i.e., parameter was empty or missing)
            if (!(xizmatlarRaw.length === 1 && xizmatlarRaw[0] === '')) {
                xizmatlarRaw.forEach((xizmat, index) => {
                    if (xizmat.trim() !== '' || (xizmatlarRaw.length === 1 && xizmat === '')) { // Keep blank item if it's the only one
                         allServiceObjects.push({
                            name: xizmat,
                            count: soniRaw[index] || '',
                        });
                    }
                });
            }
            
            const individualSpecialItemJobsData = []; // Holds items for special receipts
            const otherItemsData = [];                 // Holds items for the main/other receipt

            allServiceObjects.forEach(item => {
                // Case-insensitive check against SPECIAL_SERVICE_NAMES
                if (SPECIAL_SERVICE_NAMES.some(specialName => item.name.toUpperCase() === specialName.toUpperCase())) {
                    individualSpecialItemJobsData.push(item); // Each special item gets its own receipt
                } else {
                    otherItemsData.push(item);
                }
            });

            // Build the printJobs array
            printJobs = [];

            individualSpecialItemJobsData.forEach(specialItem => {
                printJobs.push({
                    items: [specialItem], // One item per special receipt
                    showFinancials: false, // Financials not shown on individual special item receipts by default
                    type: 'special_item'
                });
            });

            if (otherItemsData.length > 0) {
                printJobs.push({
                    items: otherItemsData,
                    showFinancials: true, // "Other items" receipt always shows financials
                    type: 'other_items'
                });
            } else if (printJobs.length > 0) {
                // If there were ONLY special items (no "other" items),
                // the LAST special item's job should show the financials.
                printJobs[printJobs.length - 1].showFinancials = true;
            } else if (allServiceObjects.length === 0 && urlParams.has('bemorismi')) {
                // Case: No actual services listed (e.g., xizmatlar was empty or missing)
                // but basic patient info exists, so print a shell receipt with financials.
                printJobs.push({
                    items: [], // No items to list
                    showFinancials: true,
                    type: 'empty_shell_financials'
                });
            }


            // Setup onafterprint handler (or fallback)
            if (typeof window.onafterprint !== 'undefined') {
                window.onafterprint = function () {
                    currentPrintJobIndex++;
                    if (currentPrintJobIndex < printJobs.length) {
                        executeNextPrintJob();
                    } else {
                        window.close(); // All jobs printed, now close
                    }
                };
            } else {
                // Fallback for browsers that don't support onafterprint
                // This will attempt to print jobs sequentially, but closing is less controlled.
                // The original PHP had onfocus="window.close()", which is aggressive.
                // This loop attempts to print all, then sets up the close.
                window.onfocus = function() { // Set up the final close attempt
                    if (currentPrintJobIndex >= printJobs.length) { // Ensure all prints were attempted
                         setTimeout(function() { if (document.hasFocus()) window.close(); }, 500);
                    }
                };
            }

            // Start the printing process if there are jobs
            if (printJobs.length > 0) {
                executeNextPrintJob();
            } else if (!urlParams.has('bemorismi')) {
                // No relevant parameters at all, maybe do nothing or show a message.
                // For now, it does nothing if no print jobs and no bemorismi.
                console.log("No print jobs and no patient info found. Nothing to print.");
            }


            // Fallback for browsers without onafterprint to iterate through prints
            // This part is tricky because window.print() is blocking.
            if (typeof window.onafterprint === 'undefined' && printJobs.length > 0) {
                // If onafterprint is not supported, we manually iterate after each print call.
                // This relies on the blocking nature of print().
                // This is a simplified loop and might have issues with the onfocus close.
                // The primary mechanism should be onafterprint.
                (async () => {
                    for (let i = 0; i < printJobs.length; i++) {
                        currentPrintJobIndex = i; // Make sure index is set for onfocus check
                        populateReceiptContent(printJobs[i]);
                        window.print(); // This blocks
                        // If we are here, print dialog was closed.
                        if (i === printJobs.length - 1) { // Last print job
                           // onfocus is already set to handle closing
                        }
                    }
                    currentPrintJobIndex = printJobs.length; // Signal all attempted
                })();
            }
        });
    </script>
</body>
</html>
